name: Build macOS GUI App

on:
  workflow_dispatch:  # 手动触发

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      # ① 拉取仓库代码
      - uses: actions/checkout@v4

      # ② 设置 Python 环境
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ③ 安装依赖
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyinstaller requests openai

      # ④ 打包成 .app
      - name: Build macOS GUI App
        run: |
          pyinstaller --windowed --onefile transonly_V0.2.py --name "TransBy" --icon "app.icns"
          echo "---- dist directory ----"
          ls -lah dist || true

      # ⑤ 检查是否包含 crypto_utils
      - name: Check contents
        run: |
          echo "---- Checking crypto_utils ----"
          find dist -name "crypto_utils*" || echo "crypto_utils not found (but may be inside .pkg)"

      # ⑥ 压缩为 zip 文件
      - name: Package as ZIP
        run: |
          cd dist
          if [ -d "TransBy.app" ]; then
            zip -r TransBy-macOS.zip TransBy.app
          elif [ -f "TransBy" ]; then
            zip -r TransBy-macOS.zip TransBy
          fi
          ls -lh

      # ⑦ 上传产物供下载
      - name: Upload macOS Build
        uses: actions/upload-artifact@v4
        with:
          name: TransBy-macOS
          path: dist/TransBy-macOS.zip
