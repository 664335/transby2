name: Build macOS GUI App

on: [workflow_dispatch]

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install pyinstaller requests openai

      - name: Build macOS GUI App (.app)
        run: |
          # 建立临时构建环境
          mkdir -p build dist

          # 打包 GUI App（不使用 --onefile）
          pyinstaller \
            --windowed \
            --onedir \
            --name "TransBy" \
            --icon "app.icns" \
            transonly_V0.2.py

          echo "✅ Build complete. Contents of dist:"
          ls -R dist

      - name: Sign the app (for Gatekeeper compatibility)
        run: |
          # 对生成的 app 进行签名
          codesign --force --deep --sign - "dist/TransBy.app" || true

          # 重新验证签名
          spctl --assess --type execute "dist/TransBy.app" || true

      - name: Compress .app
        run: |
          cd dist
          zip -r TransBy_macOS.zip TransBy.app
          cd ..

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS-App
          path: dist/TransBy_macOS.zip
